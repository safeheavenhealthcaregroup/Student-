<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - Login Protected</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    .hidden { display: none; }
    .box { background: #fff; padding: 20px; max-width: 600px; margin: auto; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 12px; border: 1px solid #ddd; }
  </style>
</head>
<body>

<div id="loginBox" class="box">
  <h2>Admin Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="adminLogin()">Login</button>
  <div id="loginMessage"></div>
</div>

<div id="adminPanel" class="box hidden">
  <h2>Welcome, Admin</h2>
  <button onclick="logout()">Logout</button>
  <table id="studentTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Class</th>
        <th>Attendance</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBC-go9YTEF1o15fcYUigCtzMv8yMBZois",
    authDomain: "student-8ee94.firebaseapp.com",
    projectId: "student-8ee94",
    storageBucket: "student-8ee94.firebasestorage.app",
    messagingSenderId: "877165909465",
    appId: "1:877165909465:web:ce5c05f9295547f4c2b5c8",
    measurementId: "G-KRSM7QDXMY"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginBox = document.getElementById("loginBox");
  const adminPanel = document.getElementById("adminPanel");
  const loginMessage = document.getElementById("loginMessage");
  const tableBody = document.querySelector("#studentTable tbody");

  function adminLogin() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;

    auth.signInWithEmailAndPassword(email, password)
      .then(userCred => {
        const uid = userCred.user.uid;
        // Check if user is in 'admins' collection
        return db.collection("admins").doc(uid).get();
      })
      .then(doc => {
        if (doc.exists) {
          showAdminPanel();
        } else {
          loginMessage.innerText = "Access denied. You are not an admin.";
          auth.signOut();
        }
      })
      .catch(err => {
        loginMessage.innerText = err.message;
      });
  }

  function logout() {
    auth.signOut();
    adminPanel.classList.add("hidden");
    loginBox.classList.remove("hidden");
  }

  function showAdminPanel() {
    loginBox.classList.add("hidden");
    adminPanel.classList.remove("hidden");
    loadStudents();
  }

  function loadStudents() {
    db.collection("users").onSnapshot(snapshot => {
      tableBody.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const uid = doc.id;
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="text" value="${data.name || ""}" id="name-${uid}"></td>
          <td><input type="text" value="${data.email || ""}" id="email-${uid}"></td>
          <td><input type="text" value="${data.class || ""}" id="class-${uid}"></td>
          <td>${(data.attendance || []).length} Days</td>
          <td>
            <button onclick="markAttendance('${uid}')">Mark Today</button>
            <button onclick="saveUser('${uid}')">Save</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    });
  }

  function markAttendance(uid) {
    const today = new Date().toISOString().split("T")[0];
    const docRef = db.collection("users").doc(uid);

    docRef.get().then(doc => {
      const data = doc.data();
      const currentAttendance = data.attendance || [];
      if (!currentAttendance.includes(today)) {
        currentAttendance.push(today);
        docRef.update({ attendance: currentAttendance });
      } else {
        alert("Already marked today.");
      }
    });
  }

  function saveUser(uid) {
    const name = document.getElementById("name-" + uid).value;
    const email = document.getElementById("email-" + uid).value;
    const className = document.getElementById("class-" + uid).value;

    db.collection("users").doc(uid).update({
      name: name,
      email: email,
      class: className
    }).then(() => alert("Updated!"));
  }
</script>
</body>
</html>

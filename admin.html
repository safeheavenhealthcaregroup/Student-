<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      padding: 20px;
    }
    h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 10px 15px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #343a40;
      color: white;
    }
    input {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }
    .btn {
      padding: 6px 12px;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .btn-edit {
      background: #007bff;
    }
    .btn-save {
      background: #28a745;
    }
    .hidden {
      display: none;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Admin Panel - Manage Users</h2>
  <p id="error" class="error hidden">You are not authorized to view this page.</p>
  <table id="userTable" class="hidden">
    <thead>
      <tr>
        <th>Email</th>
        <th>Name</th>
        <th>Role</th>
        <th>Attendance</th>
        <th>Attended Classes</th>
        <th>Teachers</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="userTableBody"></tbody>
  </table>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBC-go9YTEF1o15fcYUigCtzMv8yMBZois",
      authDomain: "student-8ee94.firebaseapp.com",
      projectId: "student-8ee94",
      storageBucket: "student-8ee94.firebasestorage.app",
      messagingSenderId: "877165909465",
      appId: "1:877165909465:web:ce5c05f9295547f4c2b5c8",
      measurementId: "G-KRSM7QDXMY"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const userTable = document.getElementById('userTable');
    const userTableBody = document.getElementById('userTableBody');
    const errorMessage = document.getElementById('error');

    let editingId = null;
    let editedData = {};

    // Check admin role
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const doc = await db.collection('users').doc(user.uid).get();
        const userData = doc.data();

        if (userData && userData.role === 'admin') {
          userTable.classList.remove('hidden');
          loadUsers();
        } else {
          errorMessage.classList.remove('hidden');
        }
      } else {
        errorMessage.textContent = 'You must be logged in to access this page.';
        errorMessage.classList.remove('hidden');
      }
    });

    const loadUsers = async () => {
      userTableBody.innerHTML = '';
      const snapshot = await db.collection('users').get();
      snapshot.forEach(doc => {
        const user = doc.data();
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${editingId === doc.id ? `<input value="${user.email || ''}" onchange="editedData.email = this.value">` : user.email || ''}</td>
          <td>${editingId === doc.id ? `<input value="${user.name || ''}" onchange="editedData.name = this.value">` : user.name || ''}</td>
          <td>${editingId === doc.id ? `<input value="${user.role || ''}" onchange="editedData.role = this.value">` : user.role || ''}</td>
          <td>${editingId === doc.id ? `<input value="${user.attendance || ''}" onchange="editedData.attendance = this.value">` : user.attendance || ''}</td>
          <td>${editingId === doc.id ? `<input value="${user.attendedClasses || ''}" onchange="editedData.attendedClasses = this.value">` : user.attendedClasses || ''}</td>
          <td>${editingId === doc.id ? `<input value="${user.teachers || ''}" onchange="editedData.teachers = this.value">` : user.teachers || ''}</td>
          <td>
            ${editingId === doc.id
              ? `<button class="btn btn-save" onclick="saveUser('${doc.id}')">Save</button>`
              : `<button class="btn btn-edit" onclick='editUser("${doc.id}", ${JSON.stringify(user).replace(/"/g, '&quot;')})'>Edit</button>`
            }
          </td>
        `;
        userTableBody.appendChild(row);
      });
    };

    function editUser(id, user) {
      editingId = id;
      editedData = { ...user };
      loadUsers();
    }

    async function saveUser(id) {
      await db.collection('users').doc(id).update(editedData);
      editingId = null;
      editedData = {};
      loadUsers();
    }
  </script>
</body>
</html>
